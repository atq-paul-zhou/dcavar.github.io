<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/Documents/Web/DC/ChartyPy/charty.rkt.html</title>
<meta name="Generator" content="Vim/7.3">
<meta name="plugin-version" content="vim7.3_v10">
<meta name="syntax" content="scheme">
<meta name="settings" content="use_css,pre_wrap,expand_tabs">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
.Boolean { color: #cd0000; }
.Constant { color: #ff8c00; }
.String { color: #4a708b; }
.Identifier { color: #458b74; }
.Statement { color: #b03060; font-weight: bold; }
.Special { color: #8a2be2; }
.Comment { color: #0000ee; font-style: italic; }
.Error { color: #ffffff; background-color: #cd2626; }
-->
</style>
</head>
<body>
<pre>
<span class="Error">#!/usr/bin/env</span> racket

<span class="Error">#lang</span> racket/base


<span class="Comment">;;; ----------------------------------------------------</span>
<span class="Comment">;;; Filename: charty.rkt</span>
<span class="Comment">;;; Author:   Damir Cavar &lt;damir@cavar.me&gt;</span>
<span class="Comment">;;; Version:  0.2</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; (C) 2006-2011 by Damir Cavar</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; This code is published under the Lesser GPL!</span>
<span class="Comment">;;; Please find the text of the LGPL here:</span>
<span class="Comment">;;; <a href="http://www.gnu.org/licenses/lgpl.txt">http://www.gnu.org/licenses/lgpl.txt</a></span>
<span class="Comment">;;; </span>
<span class="Comment">;;; It is free for use, change, etc. as long as the copyright</span>
<span class="Comment">;;; note above is included in any modified version of the code.</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; Usage:</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; racket -qtm charty.rkt -g PSG1.txt -s &quot;John kissed Mary&quot;</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; or, if charty.rkt is executable</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; ./charty.rkt -g PSG1.txt -s &quot;John kissed Mary&quot;</span>
<span class="Comment">;;;</span>
<span class="Comment">;;; ----------------------------------------------------</span>


<span class="Special">(</span>require srfi/1<span class="Special">)</span>
<span class="Special">(</span>require racket/file<span class="Special">)</span>
<span class="Special">(</span>require racket/cmdline<span class="Special">)</span>


<span class="Comment">;-----------------------------------------------------------------------</span>
<span class="Comment">; some global definitions</span>

<span class="Special">(</span><span class="Statement">define</span> rule-re <span class="Special">(</span>pregexp
                 <span class="Special">(</span><span class="Identifier">string-append</span>
                  <span class="String">&quot;([^-=&gt;#,\\s]+(?:[-]+[^-=&gt;#,\\s]+)*)&quot;</span> <span class="Comment">; symbol [^-=&gt;#,\s]+([-]+[^-=&gt;#,\s]+)*</span>
                  <span class="String">&quot;(?:\\s+(?:-+|=+)&gt;\\s+)&quot;</span>              <span class="Comment">; arrow or production symbol</span>
                  <span class="String">&quot;([^-=&gt;#,\\s]+(?:[-]+[^-=&gt;#,\\s]+)*(?:\\s+[^-=&gt;#,\\s]+(?:[-]+[^-=&gt;#,\\s]+)*)*)&quot;</span>
                  <span class="String">&quot;(?:\\s+#.*)?&quot;</span><span class="Special">)))</span> <span class="Comment">; comment</span>

<span class="Special">(</span>struct grammar <span class="Special">(</span>lhs lprhs terminals symbols<span class="Special">)</span> <span class="Error">#:mutable</span> <span class="Error">#:transparent</span><span class="Special">)</span>


<span class="Comment">;-----------------------------------------------------------------------</span>
<span class="Comment">; the grammar processing functions</span>

<span class="Special">(</span><span class="Statement">define</span> parse-grammar
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>grammar-file grammar<span class="Special">)</span> <span class="Comment">; TODO exception handling for the file-&gt;lines procedure</span>
    <span class="Special">(</span><span class="Identifier">for-each</span>
     <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>line<span class="Special">)</span>
       <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>lmatch <span class="Special">(</span>regexp-match rule-re line<span class="Special">)])</span>
         <span class="Special">(</span>when <span class="Special">(</span><span class="Statement">and</span> lmatch
                    <span class="Special">(</span><span class="Identifier">=</span> <span class="Special">(</span><span class="Identifier">length</span> lmatch<span class="Special">)</span> <span class="Constant">3</span><span class="Special">))</span>
           <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>lhs <span class="Special">(</span><span class="Identifier">string-&gt;symbol</span> <span class="Special">(</span><span class="Identifier">list-ref</span> lmatch <span class="Constant">1</span><span class="Special">))]</span>
                 <span class="Special">[</span>rhs <span class="Special">(</span><span class="Identifier">map</span> <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>token<span class="Special">)</span>
                             <span class="Special">(</span><span class="Identifier">string-&gt;symbol</span> token<span class="Special">))</span>
                           <span class="Special">(</span>regexp-split <span class="Error">#rx</span><span class="String">&quot; +&quot;</span> <span class="Special">(</span><span class="Identifier">list-ref</span> lmatch <span class="Constant">2</span><span class="Special">)))])</span>
             <span class="Special">(</span>hash-set! <span class="Special">(</span>grammar-symbols grammar<span class="Special">)</span> lhs <span class="Boolean">#t</span><span class="Special">)</span>
             <span class="Special">(</span><span class="Identifier">for-each</span>
              <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>token<span class="Special">)</span>
                <span class="Special">(</span>hash-set! <span class="Special">(</span>grammar-terminals grammar<span class="Special">)</span> token <span class="Boolean">#t</span><span class="Special">))</span>
              rhs<span class="Special">)</span>
             <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>val  <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-lhs grammar<span class="Special">)</span>   lhs              <span class="Special">'())]</span>
                   <span class="Special">[</span>rval <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-lprhs grammar<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">list-ref</span> rhs <span class="Constant">0</span><span class="Special">)</span> <span class="Special">'())])</span>
               <span class="Special">(</span>unless <span class="Special">(</span><span class="Identifier">member</span> <span class="Special">(</span><span class="Identifier">list</span> lhs rhs<span class="Special">)</span> rval<span class="Special">)</span>
                 <span class="Special">(</span>hash-set! <span class="Special">(</span>grammar-lprhs grammar<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">list-ref</span> rhs <span class="Constant">0</span><span class="Special">)</span> <span class="Special">(</span><span class="Identifier">append</span> rval <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">list</span> lhs <span class="Special">(</span><span class="Identifier">cdr</span> rhs<span class="Special">))))))</span>
               <span class="Special">(</span>unless <span class="Special">(</span><span class="Identifier">member</span> rhs val<span class="Special">)</span>
                 <span class="Special">(</span>hash-set! <span class="Special">(</span>grammar-lhs grammar<span class="Special">)</span> lhs <span class="Special">(</span><span class="Identifier">append</span> val <span class="Special">(</span><span class="Identifier">list</span> rhs<span class="Special">)))))))))</span>
     <span class="Special">(</span>file-&gt;lines grammar-file<span class="Special">))</span>
    <span class="Special">(</span><span class="Identifier">for-each</span>
     <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>key<span class="Special">)</span>
       <span class="Special">(</span>hash-remove! <span class="Special">(</span>grammar-terminals grammar<span class="Special">)</span> key<span class="Special">))</span>
     <span class="Special">(</span>hash-keys <span class="Special">(</span>grammar-symbols grammar<span class="Special">)))</span>
    grammar<span class="Special">))</span>



<span class="Special">(</span><span class="Statement">define</span> new-grammar
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>grammar-file<span class="Special">)</span>
    <span class="Special">(</span>parse-grammar grammar-file <span class="Special">(</span>grammar <span class="Special">(</span>make-hash<span class="Special">)</span> <span class="Special">(</span>make-hash<span class="Special">)</span> <span class="Special">(</span>make-hash<span class="Special">)</span> <span class="Special">(</span>make-hash<span class="Special">)))))</span>


<span class="Special">(</span><span class="Statement">define</span> add2grammar
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>grammar-file ogrammar<span class="Special">)</span>
    <span class="Special">(</span>parse-grammar grammar-file ogrammar<span class="Special">)))</span>


<span class="Comment">;-----------------------------------------------------------------------</span>
<span class="Comment">; the parsing functions</span>


<span class="Special">(</span><span class="Statement">define</span> verbose <span class="Boolean">#f</span><span class="Special">)</span> <span class="Comment">; be verbouse, i.e. show chart edges</span>
<span class="Special">(</span><span class="Statement">define</span> latex   <span class="Boolean">#f</span><span class="Special">)</span>   <span class="Comment">; print out latex tree definition</span>


<span class="Comment">;;; inactive-edge (edge)</span>
<span class="Comment">;;; true is edge inactive, else false</span>
<span class="Special">(</span><span class="Statement">define</span> inactive-edge
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>edge<span class="Special">)</span>
    <span class="Special">(</span><span class="Identifier">&gt;=</span> <span class="Special">(</span><span class="Identifier">caddr</span> edge<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">length</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">4</span><span class="Special">)))))</span>


<span class="Comment">;;; active-edge (edge)</span>
<span class="Comment">;;; negation of inactive-edge</span>
<span class="Special">(</span>define-syntax-rule <span class="Special">(</span>active-edge edge<span class="Special">)</span>
  <span class="Special">(</span><span class="Identifier">not</span> <span class="Special">(</span>inactive-edge edge<span class="Special">)))</span>


<span class="Special">(</span><span class="Statement">define</span> terminal?
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar token<span class="Special">)</span>
    <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-terminals mgrammar<span class="Special">)</span> token <span class="Boolean">#f</span><span class="Special">)))</span>


<span class="Special">(</span><span class="Statement">define</span> <span class="Identifier">symbol?</span>
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar token<span class="Special">)</span>
    <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-symbols mgrammar<span class="Special">)</span> token <span class="Boolean">#f</span><span class="Special">)))</span>


<span class="Comment">;;; rule-invocation</span>
<span class="Comment">;;; find complete edges and add rules that have the LHS symbol</span>
<span class="Comment">;;; as the first RHS symbol</span>
<span class="Special">(</span><span class="Statement">define</span> rule-invocation
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar chart start<span class="Special">)</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>res <span class="Special">'()])</span>
      <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Comment">; edge on chart starting from start</span>
       <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>edge<span class="Special">)</span>
         <span class="Special">(</span><span class="Statement">cond</span> <span class="Special">[(</span>inactive-edge edge<span class="Special">)</span> <span class="Comment">; if edge not active</span>
                <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>rhss <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-lprhs mgrammar<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">3</span><span class="Special">)</span> <span class="Special">'())])</span>
                  <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Comment">; for each RHS with LHS as initial symbol</span>
                   <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>x<span class="Special">)</span>
                     <span class="Special">(</span><span class="Statement">let*</span> <span class="Special">([</span>newedge <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">car</span> edge<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">cadr</span> edge<span class="Special">)</span> <span class="Constant">1</span> <span class="Special">(</span><span class="Identifier">list-ref</span> x <span class="Constant">0</span><span class="Special">)</span>
                                           <span class="Special">(</span><span class="Identifier">append</span> <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">3</span><span class="Special">))</span> <span class="Special">(</span><span class="Identifier">list-ref</span> x <span class="Constant">1</span><span class="Special">))</span>
                                           <span class="Special">(</span><span class="Identifier">append</span> <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span>list-index
                                                          <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>el<span class="Special">)</span>
                                                            <span class="Special">(</span><span class="Identifier">eq?</span> el edge<span class="Special">))</span>
                                                          chart<span class="Special">))))])</span>
                       <span class="Special">(</span>unless <span class="Special">(</span><span class="Statement">or</span> <span class="Special">(</span><span class="Identifier">member</span> newedge chart<span class="Special">)</span>
                                   <span class="Special">(</span><span class="Identifier">member</span> newedge res<span class="Special">))</span><span class="Comment">; if not on chart or res, append</span>
                         <span class="Special">(</span>when verbose
                           <span class="Special">(</span>printf <span class="String">&quot;RI new edge: ~a\n&quot;</span> newedge<span class="Special">))</span>
                         <span class="Special">(</span><span class="Statement">set!</span> res <span class="Special">(</span><span class="Identifier">append</span> res <span class="Special">(</span><span class="Identifier">list</span> newedge<span class="Special">))))))</span>
                   rhss<span class="Special">))]))</span>
       <span class="Special">(</span>drop chart start<span class="Special">))</span>
      res<span class="Special">)))</span>


<span class="Comment">;;; fundamental-rule</span>
<span class="Comment">;;; find active edges and axpand them with inactive, i.e.</span>
<span class="Comment">;;; the first symbol after the dot as their LHS symbol</span>
<span class="Special">(</span><span class="Statement">define</span> fundamental-rule
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>chart<span class="Special">)</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>res <span class="Special">'()])</span>
      <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Comment">; edge on chart</span>
       <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>edge<span class="Special">)</span>
         <span class="Special">(</span><span class="Statement">cond</span> <span class="Special">[(</span>active-edge edge<span class="Special">)</span>
                <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>expectation <span class="Special">(</span><span class="Identifier">list-ref</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">4</span><span class="Special">)</span> <span class="Special">(</span><span class="Identifier">caddr</span> edge<span class="Special">))])</span>
                  <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Comment">; edge on chart</span>
                   <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>oe<span class="Special">)</span>
                     <span class="Special">(</span><span class="Statement">cond</span> <span class="Special">[(</span>inactive-edge oe<span class="Special">)</span>
                            <span class="Special">(</span><span class="Statement">cond</span> <span class="Special">[(</span><span class="Statement">and</span> <span class="Special">(</span><span class="Identifier">eq?</span> expectation <span class="Special">(</span><span class="Identifier">list-ref</span> oe <span class="Constant">3</span><span class="Special">))</span>
                                        <span class="Special">(</span><span class="Identifier">=</span> <span class="Special">(</span><span class="Identifier">cadr</span> edge<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">car</span> oe<span class="Special">)))</span>
                                   <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>newedge <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">car</span> edge<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">cadr</span> oe<span class="Special">)</span>
                                                        <span class="Special">(</span><span class="Identifier">+</span> <span class="Special">(</span><span class="Identifier">caddr</span> edge<span class="Special">)</span> <span class="Constant">1</span><span class="Special">)</span>
                                                        <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">3</span><span class="Special">)</span>
                                                        <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">4</span><span class="Special">)</span>
                                                        <span class="Special">(</span><span class="Identifier">append</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">5</span><span class="Special">)</span>
                                                                <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span>list-index
                                                                       <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>el<span class="Special">)</span>
                                                                         <span class="Special">(</span><span class="Identifier">eq?</span> el oe<span class="Special">))</span>
                                                                       chart<span class="Special">))))])</span>
                                     <span class="Special">(</span>unless <span class="Special">(</span><span class="Statement">or</span> <span class="Special">(</span><span class="Identifier">member</span> newedge chart<span class="Special">)</span>
                                                 <span class="Special">(</span><span class="Identifier">member</span> newedge res<span class="Special">))</span>
                                       <span class="Special">(</span>when verbose
                                         <span class="Special">(</span>printf <span class="String">&quot;FR new edge: ~a\n&quot;</span> newedge<span class="Special">))</span>
                                       <span class="Special">(</span><span class="Statement">set!</span> res <span class="Special">(</span><span class="Identifier">append</span> res <span class="Special">(</span><span class="Identifier">list</span> newedge<span class="Special">)))))])]))</span>
                   chart<span class="Special">))]))</span>
       chart<span class="Special">)</span>
      res<span class="Special">)))</span>


<span class="Special">(</span><span class="Statement">define</span> parse
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar tokens<span class="Special">)</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>chart <span class="Special">'()])</span>
      <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>counter <span class="Constant">0</span><span class="Special">])</span>
        <span class="Special">(</span><span class="Identifier">for-each</span>
         <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>token<span class="Special">)</span>
           <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>vals <span class="Special">(</span>hash-ref <span class="Special">(</span>grammar-lprhs mgrammar<span class="Special">)</span> token <span class="Special">'())])</span>
             <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>y<span class="Special">)</span> <span class="Comment">; create edge with span</span>
                         <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>edge <span class="Special">(</span><span class="Identifier">list</span> counter <span class="Special">(</span><span class="Identifier">+</span> counter <span class="Constant">1</span><span class="Special">)</span> <span class="Constant">1</span> <span class="Special">(</span><span class="Identifier">list-ref</span> y <span class="Constant">0</span><span class="Special">)</span> <span class="Special">(</span><span class="Identifier">append</span> <span class="Special">(</span><span class="Identifier">list</span> token <span class="Special">)</span> <span class="Special">(</span><span class="Identifier">list-ref</span> y <span class="Constant">1</span><span class="Special">))</span> <span class="Special">'())])</span>
                           <span class="Special">(</span>unless <span class="Special">(</span><span class="Identifier">member</span> edge chart<span class="Special">)</span>
                             <span class="Special">(</span>when verbose
                               <span class="Special">(</span>printf <span class="String">&quot;Init new edge: ~a\n&quot;</span> edge<span class="Special">))</span>
                             <span class="Special">(</span><span class="Statement">set!</span> chart <span class="Special">(</span><span class="Identifier">append</span> chart <span class="Special">(</span><span class="Identifier">list</span> edge<span class="Special">))))))</span>
                       vals<span class="Special">)</span>
             <span class="Special">(</span><span class="Statement">set!</span> counter <span class="Special">(</span><span class="Identifier">+</span> counter <span class="Constant">1</span><span class="Special">))))</span>
         tokens<span class="Special">))</span>
      <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>start  <span class="Constant">0</span><span class="Special">]</span> <span class="Comment">; apply rule invocation, fundamental rule, until nothing more possible</span>
            <span class="Special">[</span>oldlen <span class="Special">(</span><span class="Identifier">length</span> chart<span class="Special">)])</span>
        <span class="Special">(</span><span class="Statement">let</span> loop <span class="Special">()</span>
          <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>res <span class="Special">(</span>rule-invocation mgrammar chart start<span class="Special">)])</span>
            <span class="Special">(</span>when <span class="Special">(</span><span class="Identifier">&gt;</span> <span class="Special">(</span><span class="Identifier">length</span> res<span class="Special">)</span> <span class="Constant">0</span><span class="Special">)</span>
              <span class="Special">(</span><span class="Statement">set!</span> chart <span class="Special">(</span><span class="Identifier">append</span> chart res<span class="Special">))))</span>
          <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>res <span class="Special">(</span>fundamental-rule chart<span class="Special">)])</span>
            <span class="Special">(</span>when <span class="Special">(</span><span class="Identifier">&gt;</span> <span class="Special">(</span><span class="Identifier">length</span> res<span class="Special">)</span> <span class="Constant">0</span><span class="Special">)</span>
              <span class="Special">(</span><span class="Statement">set!</span> chart <span class="Special">(</span><span class="Identifier">append</span> chart res<span class="Special">))))</span>
          <span class="Comment">; something changed on the chart</span>
          <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>nlen <span class="Special">(</span><span class="Identifier">length</span> chart<span class="Special">)])</span>
            <span class="Special">(</span><span class="Statement">cond</span> <span class="Special">[(</span><span class="Identifier">&gt;</span> nlen oldlen<span class="Special">)</span>
                   <span class="Special">(</span><span class="Statement">begin</span>
                     <span class="Special">(</span><span class="Statement">set!</span> oldlen nlen<span class="Special">)</span>
                     <span class="Special">(</span>loop<span class="Special">))]))))</span>
      chart<span class="Special">)))</span>


<span class="Comment">;;; serialize-chart</span>
<span class="Comment">;;; create lists of complete overspanning edges</span>
<span class="Special">(</span><span class="Statement">define</span> serialize-chart
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar chart input <span class="Special">(</span>with-span <span class="Boolean">#f</span><span class="Special">))</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>end <span class="Special">(</span><span class="Identifier">length</span> input<span class="Special">)])</span>
      <span class="Special">(</span>for/list <span class="Special">((</span>edge <span class="Special">(</span>in-list <span class="Special">(</span><span class="Identifier">reverse</span> chart<span class="Special">)))</span>
                 <span class="Error">#:when</span> <span class="Special">(</span><span class="Statement">and</span> <span class="Special">(</span>inactive-edge edge<span class="Special">)</span> <span class="Comment">; inactive edge</span>
                             <span class="Special">(</span><span class="Identifier">=</span> <span class="Special">(</span><span class="Identifier">car</span> edge<span class="Special">)</span> <span class="Constant">0</span><span class="Special">)</span>     <span class="Comment">; from beginning</span>
                             <span class="Special">(</span><span class="Identifier">=</span> <span class="Special">(</span><span class="Identifier">cadr</span> edge<span class="Special">)</span> end<span class="Special">)))</span>
        <span class="Special">(</span>edge-&gt;list mgrammar chart edge with-span<span class="Special">)))))</span>


<span class="Comment">;;; edge-&gt;list</span>
<span class="Comment">;;; converts embedded edges into an embedded list</span>
<span class="Comment">;;; if with-span is #t each node is preceded by its span index</span>
<span class="Special">(</span><span class="Statement">define</span> edge-&gt;list
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>mgrammar chart edge <span class="Special">(</span>with-span <span class="Boolean">#f</span><span class="Special">))</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>analysis <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">3</span><span class="Special">))])</span>
      <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>rule-counter <span class="Constant">0</span><span class="Special">])</span>
        <span class="Special">(</span><span class="Identifier">for-each</span>
         <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>token<span class="Special">)</span>
           <span class="Special">(</span><span class="Statement">if</span> <span class="Special">(</span>terminal? mgrammar token<span class="Special">)</span>
               <span class="Special">(</span><span class="Statement">set!</span> analysis <span class="Special">(</span><span class="Identifier">append</span> analysis <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span><span class="Identifier">list-ref</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">4</span><span class="Special">)</span> <span class="Constant">0</span><span class="Special">))))</span>
               <span class="Special">(</span><span class="Statement">begin</span>
                 <span class="Special">(</span><span class="Statement">set!</span> analysis
                       <span class="Special">(</span><span class="Identifier">append</span> analysis
                               <span class="Special">(</span><span class="Identifier">list</span> <span class="Special">(</span>edge-&gt;list mgrammar chart
                                                 <span class="Special">(</span><span class="Identifier">list-ref</span> chart
                                                           <span class="Special">(</span><span class="Identifier">list-ref</span> <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">5</span><span class="Special">)</span> rule-counter<span class="Special">))</span> with-span<span class="Special">))))</span>
                 <span class="Special">(</span><span class="Statement">set!</span> rule-counter <span class="Special">(</span>add1 rule-counter<span class="Special">)))))</span>
         <span class="Special">(</span><span class="Identifier">list-ref</span> edge <span class="Constant">4</span><span class="Special">)))</span>
      analysis<span class="Special">)))</span>


<span class="Comment">;-----------------------------------------------------------------------</span>


<span class="Special">(</span><span class="Statement">define</span> <span class="Special">(</span>sublist l offset n<span class="Special">)</span>
  <span class="Special">(</span>take <span class="Special">(</span>drop l offset<span class="Special">)</span> n<span class="Special">))</span>


<span class="Special">(</span><span class="Statement">define</span> main
  <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">()</span>
    <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>grammar-file   <span class="String">&quot;&quot;</span><span class="Special">]</span>
          <span class="Special">[</span>input-sentence <span class="String">&quot;&quot;</span><span class="Special">])</span>
      <span class="Special">(</span><span class="Statement">define</span> sentence-to-parse
        <span class="Special">(</span>command-line
         <span class="Error">#:program</span> <span class="String">&quot;charty&quot;</span>
         <span class="Error">#:once-each</span>
         <span class="Special">[(</span><span class="String">&quot;-v&quot;</span> <span class="String">&quot;--verbose&quot;</span><span class="Special">)</span> <span class="String">&quot;Verbose mode&quot;</span> <span class="Special">(</span><span class="Statement">set!</span> verbose <span class="Boolean">#t</span><span class="Special">)]</span>
         <span class="Special">[(</span><span class="String">&quot;-l&quot;</span> <span class="String">&quot;--latex&quot;</span><span class="Special">)</span> <span class="String">&quot;LaTeX Qtree output mode&quot;</span> <span class="Special">(</span><span class="Statement">set!</span> latex <span class="Boolean">#t</span><span class="Special">)]</span>
         <span class="Special">[(</span><span class="String">&quot;-g&quot;</span> <span class="String">&quot;--grammar&quot;</span><span class="Special">)</span> gf <span class="String">&quot;Grammar file name&quot;</span> <span class="Special">(</span><span class="Statement">set!</span> grammar-file gf<span class="Special">)]</span>
         <span class="Special">[(</span><span class="String">&quot;-s&quot;</span> <span class="String">&quot;--sentence&quot;</span><span class="Special">)</span> is <span class="String">&quot;Input sentence&quot;</span> <span class="Special">(</span><span class="Statement">set!</span> input-sentence is<span class="Special">)]))</span>
      <span class="Special">(</span>when <span class="Special">(</span><span class="Statement">and</span> <span class="Special">(</span><span class="Identifier">&gt;</span> <span class="Special">(</span><span class="Identifier">string-length</span> grammar-file<span class="Special">)</span> <span class="Constant">0</span><span class="Special">)</span>
                 <span class="Special">(</span><span class="Identifier">&gt;</span> <span class="Special">(</span><span class="Identifier">string-length</span> input-sentence<span class="Special">)</span> <span class="Constant">0</span><span class="Special">))</span>
        <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>mygrammar <span class="Special">(</span>new-grammar grammar-file<span class="Special">)]</span>
              <span class="Special">[</span>input <span class="Special">(</span><span class="Identifier">map</span> <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>t<span class="Special">)</span> <span class="Special">(</span><span class="Identifier">string-&gt;symbol</span> t<span class="Special">))</span> <span class="Special">(</span>regexp-split <span class="Error">#rx</span><span class="String">&quot; +&quot;</span> input-sentence<span class="Special">))])</span>
          <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>chart <span class="Special">(</span>parse mygrammar input<span class="Special">)])</span>
            <span class="Special">(</span><span class="Statement">let</span> <span class="Special">([</span>counter <span class="Constant">0</span><span class="Special">])</span>
              <span class="Special">(</span><span class="Identifier">for-each</span> <span class="Special">(</span><span class="Statement">lambda</span> <span class="Special">(</span>x<span class="Special">)</span>
                          <span class="Special">(</span><span class="Statement">set!</span> counter <span class="Special">(</span><span class="Identifier">+</span> counter <span class="Constant">1</span><span class="Special">))</span>
                          <span class="Special">(</span>printf <span class="String">&quot;Parse ~a: ~a\n&quot;</span> counter x<span class="Special">))</span>
                        <span class="Special">(</span>serialize-chart mygrammar chart input <span class="Boolean">#f</span><span class="Special">)))))))))</span>

<span class="Comment">;(provide main)</span>
<span class="Special">(</span>main<span class="Special">)</span>
</pre>

<br/>
<br/>
<center>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-8896209246743797";
/* HomePage-DC-small */
google_ad_slot = "9466016636";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-21704386-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
